---
layout: assignment
title: CouchDB Assignment
---

<div class="csusbdt-video-btn">
  <a class="btn btn-success" role="button" target="_blank" href="">Video</a>
</div>

<h2>Overview</h2>

<p>
The purpose of this assignment 
is to learn about a database 
called <a href="http://couchdb.apache.org/">CouchDB</a>.
</p>

<p>
The code developed in this course
relies only on the ability
of CouchDB to function as a key-value store.
As a result, the code can be more easily modified
to work with any number of datastores that
provide simple key-value functionality.
</p>

<p>
A key-value datastore is a map that associates keys with values.
In CouchDB, the keys are strings and the values are JSON 
documents, which are also strings.
Because JSON strings represent objects in Javascript
and other languages,
you can think of a key-value store as an object store.
If you know the key for an object,
you can easily look up the object.
Key-value stores give you the following basic operations,
expressed in pseudo code.
</p>

<pre>
value get(key)
void  put(key, value)
void  delete(key)
</pre>

<p>
Compared to relational databases,
key-value stores are simple and fast,
but do not provide a simple query mechanism.
As a result, it is difficult to answer questions about the data, such as 
<em>how many customers spent more than 30 dollars?</em>
</p>

<p>
CouchDB provides 
<a href="http://en.wikipedia.org/wiki/Multi-master_replication">multi-master replication</a>.
When a Web application writes to anyone of the database servers,
the write operation finishes quickly on the chosen server 
and eventually propagates to all the servers.
If writes to different database servers are in conflict,
the conflict will eventually be detected,
and must be resolved at the application level.
</p>

<p>
Multi-master replication provides a means to increase
availability and responsiveness in applications
but enables inconsistencies that must be 
handled by application code.
We will not cover these topics any further in this course.
However, I'm interested in this problem,
so let me know if you want to 
do an independant study or master's project in this area.
</p>

<p>
This assignment uses <a href="http://curl.haxx.se/">curl</a> 
at the command line to explore how CouchDB works.
</p>

<h2>Reading</h2>

<p>
To better understand this assignment, 
you will need to read about CouchDB and about databases in general.
Here are some resources that I used.
</p>

<ul>
<li><a href="http://docs.couchdb.org/en/latest/intro.html">Introduction</a></li>
<li><a href="http://www.relaxed.tv/">Get friendly with CouchDB</a> (video)</li>
<li><a href="http://guide.couchdb.org/editions/1/en/index.html">CouchDB The Definitive Guide</a></li>
<li><a href="http://jpmens.net/2010/04/20/the-antepenultimate-couchdb-reference-card/">The Antepenultimate CouchDB Reference Card (cheat sheet)</a></li>
<li><a href="http://sauceio.com/index.php/2012/05/goodbye-couchdb/">Goodbye, CouchDB</a></li>
<li><a href="http://www.julianbrowne.com/article/viewer/brewers-cap-theorem">Brewer's CAP Theorem</a></li>
<li><a href="http://www.allthingsdistributed.com/2008/12/eventually_consistent.html">Eventually Consistent - Revisited</a></li>
<li><a href="http://seldo.com/weblog/2010/07/12/in_defence_of_sql">In defence of SQL</a></li>
</ul>

<h2>Assignment Folder</h2>

<p>
Create a directory named <em>couch</em> 
for the work you do for this assignment. 
At the end of the assignment, 
this folder will contain the following files.
</p>

<ul>
<li>d.json</li>
<li>createdb.bat (if on Windows) or createdb.sh (if on OS X or Linux)</li>
</ul>

<h2>Instructions</h2>

<h3>Install and Run CouchDB</h3>

<p>
Install CouchDB and start it. 
When Couch starts, 
it will open a tab inside your browser
and retrieve the main page of <em>Futon</em>, 
the browser-based interface 
to the database.
The instructions in this assignment 
do not involve this interface,
but it is probably useful to learn.
</p>

<p>
I can think of 4 ways to interact with a CouchDB database.
</p>

<ul>
<li>The browser interface (Futon).</li>
<li>Indirectly through a CouchDB driver written for a specific language.</li>
<li>Directly from a language that supports construction of HTTP messages.</li>
<li>Command line tools that support the construction of HTTP messages, such as curl.</li>
</ul>

<h3>Define a Server Admin User</h3>

<p>
When you first install and run CouchDB
there are no database users,
so the Couch server runs every operation submitted to it.
To close this security hole,
we will define a server admin user,
which is a user who can operate on databaes.
We will use the following abilities that 
con only be performed by 
a server admin user.
</p>

<ul>
<li>Create a database.</li>
<li>Delete a database.</li>
<li>Insert a security object into a database to control access to the database.</li>
</ul>

<p>
The instructions in this assignment
assume that you create a server admin user 
named <em>admin</em> with password <em>1234</em>.
You can create this user through the Futon interface or
by issuing the following command.
</p>

<pre>
curl -X PUT http://localhost:5984/_config/admins/admin -d '"1234"'
</pre>

<p>
Creating a server admin user keeps non-admin users 
from performing server administration tasks.
To see that non-authenticated users can not create databases,
try to create a database named <code>test</code> 
with the following command.
</p>

<pre>
curl -X PUT http://localhost:5984/test
</pre>

<p>
To create a database,
you can provide the username 
and password of a server admin in the HTTP request URL.
The following shows how to do this for our example.
</p>

<pre>
curl -X PUT http://admin:1234@localhost:5984/test
</pre>

<p>
After running the above command,
run the following to verify 
that a database named <em>test</em> was created.
</p>

<pre>
curl -X GET http://admin:1234@localhost:5984/_all_dbs
</pre>

<p>
The above command returns an array of names 
of the databases hosted by the server.
Observe that <em>test</em> is in the list.
</p>

<p>
Run the following to delete database <em>test</em>.
</p>

<pre>
curl -X DELETE http://admin:1234@localhost:5984/test
</pre>

<h3>Insert a Security Object</h3>

<p>
We already learned about the concept of a server admin user.
There are also database member users and database admin users.
Databse member users can read and write documents in the database,
but can not write design documents.
Database admin users can read and write all docuemnts.
Design documents provide additional capabilities beyond key-value store
operations, such as providing a means to query the data.
However, we will not cover design documents in this course.
</p>

<p>
The member and admin users for a database are specified
in a database security object.
If no users are specified in the security object in a database,
then non-authenticated clients can access the database.
To avoid this,
we will insert a secrity object 
that enables access by only our existing server admin user.
</p>

<p>
Use what you learned in the previous section
to create a database named <em>test</em>.
</p>

<p>
After creating the test database,
run the following command to 
verify that we can access information about it.
</p>

<pre>
curl -X GET http://localhost:5984/test
</pre>

<p>
Run the following command to insert a security object
into the test database that only allows server admin access.
Note the use of <code>'\'</code> for line continuation.
</p>

<pre>
curl -X PUT http://admin:1234@localhost:5984/test/_security  \
     -H "Content-type: application/json"                     \
     -d '{"members":{"names":["admin"]}}'
</pre>

<p class="csusbdt-callout">
On Windows, use '%' instead of '\' for line continuation.
</p>

<p>
Now, verify that we can no longer access the test database
without specifying the server admin credentials.
</p>

<pre>
curl -X GET http://localhost:5984/test
</pre>

<p>
From this point on,
we need to provide the username and password
of the server admin user
in the HTTP request as shown in the following.
</p>

<pre>
curl -X GET http://admin:1234@localhost:5984/test
</pre>

<h3>Insert Database Documents</h3>

<p>
In this section,
we will practice inserting, replacing and deleting documents
from a database named <em>test</em>.
Use what you learned in the previous section 
to create a database named <em>test</em>.
</p>

<p>
Use the following command to 
verify that the test database contains no documents.
</p>

<pre>
curl -X GET http://admin:1234@localhost:5984/test/_all_docs
</pre>

<p>
CouchDB stores documents in the form of JSON strings.
To see this,
consider the following Javascript object.
</p>

<pre>
var obj = { _id: 'a', x: 1 };
</pre>

<p>
Suppose we want to store the current state of this object in the test database.
To do this, we need to describe the object using [JSON](http://json.org/) syntax.
We can either write the JSON string manually, or we can use
the JSON.stringify function to determine it for us.
To do this, run the node command line interpreter.
</p>

<pre>
node
</pre>

<p>
Then, enter the following lines.
</p>

<pre>
obj = { _id: 'a', x: 1};
JSON.stringify(obj);
</pre>

<p>
The node command line interpreter displays the value of the expression entered.
The value of <code>JSON.stringify(obj);</code> is the following string.
</p>

<pre>
'{"_id":"a","x":1}'
</pre>

<p>
The outer apostrophes are used to show that the value is a string;
these are not actually part of the JSON representation of <code>obj</code>.
</p>
 
<p>
Use curl as follows to send the JSON representation of obj to the test database.
Note that the value for the <code>-d</code> argument needs to be quoted.
</p>

<pre>
curl -X POST http://admin:1234@localhost:5984/test  \
     -H "Content-type: application/json"            \
     -d '{"_id":"a","x":1}'
</pre>

<p>
Use the following command to 
verify that the test database contains the document.
</p>

<pre>
curl -X GET http://localhost:5984/test/_all_docs
</pre>

<p>
Insert JSON representations of the following additional Javascript objects.
</p>

<pre>
{ _id: 'b', x: 2 }
{ _id: 'c', y: 1 }
</pre>


<h3>Database Creation Script</h3>

<p>
When developing an application that relies on a database,
it is very useful to have a script that resets the application's database
to a specific state.
This allows you to test for specific functionality that you may be in the
process of developing.
It also allows you to easily delete old data that may not be consistent with
recent changes to application logic.
Create a script file named <em>createdb.bat</em> (if on Windows) or
<em>createdb.sh</em> (if on OS X or Linux) that deletes the test database
and then recreates it with the empty security object and example documents
used in this assignment.
</p>

<p>
When developing test cases,
it is convenient to read JSON documents from files
rather than including them directly 
in the database creation script.
Let's see how to do this.
</p>

<p>
Create a file named <em>d.json</em> with the following contents.
</p>

<pre>
{ "_id": "d", "y": 8 }
</pre>

<p>
Modify your database creation script
to insert the contents of <em>d.json</em>
into the database.
Do this with the following command.
</p>

<pre>
curl -X POST http://admin:1234@localhost:5984/test  \
     -H "Content-type: application/json"            \
     -d @d.json
</pre>

<p>
Verify that your script creates a database
that contains documents with ids <em>a</em> through <em>d</em>,
and that access to the database is restricted to the server admin user.
</p>

<span class="text-muted" style="visibility: hidden">

<h2>OPTIONAL MATERIAL STARTS HERE</h2>

<p>
This section covers a feature of CouchDB called <em>views</em>,
which rely on a technique called 
<a href="http://en.wikipedia.org/wiki/MapReduce">MapReduce</a>.
</p>

<h3>Views</h3>

<p>
In a Couch database, documents that have ids that are prefixed with _design
have a special function and are called <em>design documents</em>.
Design documents contain Javascript functions that are run at various times.
One type of design document function is called a view.
A view is used to generate derived data from the database,
similar to an SQL query.
</p>

<p>
The following design document has an id of <code>_design/adesign</code>. 
It contains a sub-object
named <code>views</code>, which contains a single view named <code>aview</code>.
This view has map and reduce functions defined.
Couch uses an approach called <code>MapReduce</code> to maintain views efficiently;
you can read about it in
<a href="http://wiki.apache.org/couchdb/Introduction_to_CouchDB_views">Introduction to CouchDB Views</a>.
</p>

<pre>
{
  "_id" : "_design/adesign",
  "views" : {
    "aview" : {
      "map" : "function(doc) { if (doc.x) emit('x', doc.x); }",
      "reduce" : "function(key, values) { return sum(values); }"
    }
  }
}
</pre>

<p>
The view <code>aview</code> computes the sum of all values for <code>x</code> 
that exist in documents within the test database.
</p>

<p>
The design document is inserted into the database 
in the same way any document is inserted.
Because the design document is relatively large, 
it is not convenient to include
it in the command line.
Instead, we store the design document as a file 
and provide the filename in the command line.
</p>

<p>
Create file <em>adesign.json</em> with contents equal to the design document given above.
Then use the following command to insert it into the test database.
</p>

<pre>
curl -X POST http://localhost:5984/test -H "Content-type: application/json" -d @adesign.json
</pre>

<p>
Notice the use of <code>'@'</code> in front of the filename.
This tells curl to treat the string as a filename.
</p>

<p>
Look again at the map function in the design document.
This function is called for each document 
that gets created or modified in the database.
The following is the function reformatted to read more easily.
</p>

<pre>
function(doc) { 
  if (doc.x) {
    emit('x', doc.x); 
  }
}
</pre>

<p>
Each time the function is called,
the function checks to see if <code>doc.x</code> 
evaluates to <code>true</code>.
If it does, then it invokes a function called <code>emit</code>,
which is provided by the Javascript runtime environment of the database.
The function <code>emit</code> 
returns a pair that is used to update a map
that is maintained by the view.
In our case, we associate the name <code>'x'</code> 
with the value of <code>doc.x</code>
when <code>doc.x</code> exists.
</p>

<p>
Now look at the reduce function.
</p>

<pre>
function(key, values) { 
  return sum(values); 
}
</pre>

<p>
The reduce function is called to aggregate values returned by the map function.
The first argument (<code>key</code> above) 
provides information about where the values came from.
See <a href="http://wiki.apache.org/couchdb/Introduction_to_CouchDB_views">Introduction to CouchDB Views</a>
for a detailed explanation.
The second argument of the reduce function (<code>values</code> above)
is an array of values that the reduce function should aggregate into a single value,
which it returns.
In our case, <code>values</code> is an array that contains
values of <code>x</code> that we emitted in the map function.
</p>

<p>
To see the result of the view, do the following.
</p>

<pre>
curl -X GET http://localhost:5984/test/_design/adesign/_view/aview
</pre>

<h3>View Logging</h3>

<p>
It is possible to write to a log file from within design functions.
To illustrate this, add a <code>bview</code> to the design document 
that uses the following map function.
</p>

<pre>
function(doc) {
  log('The doc id is " + doc._id);
}
</pre>

<p>
Run the createdb script to recreate your test database.
Then invoke the bview as follows.
(Add admin credentials as needed in subsequent commands.)
</p>

<pre>
curl -X GET http://localhost:5984/test/_design/adesign/_view/bview
</pre>

<p>
View the contents of the Couch log file to see the result.
Under OS X, the Couch log file is located at <em>~/Library/Logs/couchdb.log</em>.
You can view the log as it's being written with the following command.
</p>

<pre>
tail -f ~/Library/Logs/couchdb.log
</pre>

<p>
Under Linux, the tail command given above is also available,
but the location of the log file will be different.
Use your research skills to determine where this log file is located under Linux.
</p>

<p>
Under Windows, I don't believe the tail command is available by default.
In this case, just open the file in something like notepad to view its
contents, and re-open the file to see new contents that are added to it.
</p>

<p>
While trying to understand how map reduce works, I found it helpful to
call the log function inside the map and reduce functions.
</p>

</span>


