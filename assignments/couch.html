---
layout: assignment
title: CouchDB Assignment
---

<h2>Overview</h2>

<p>
The purpose of this assignment 
is to learn how to setup a database 
called <a href="http://couchdb.apache.org/">CouchDB</a>.
</p>

<h2>Assignment folder</h2>

<p>
Create a directory named <code>couch</code> 
for the work you do for this assignment. 
At the end of the assignment, 
this folder will contain the following files.
</p>

<ul>
<li>README.md</li>
<li>adesign.json</li>
<li>security.json</li>
<li>createdb.bat (if on Windows) or createdb.sh (if on OS X or Linux)</li>
</ul>

<h2>Reading</h2>

<p>
To fully understand this assignment, 
you will need to read about CouchDB.
Here are some resources that I used.
</p>

<ul>
<li><a href="http://docs.couchdb.org/en/latest/intro.html">Introduction</a></li>
<li><a href="http://www.relaxed.tv/">Get friendly with CouchDB</a> (video)</li>
<li><a href="http://guide.couchdb.org/editions/1/en/index.html">CouchDB The Definitive Guide</a></li>
<li><a href="http://jpmens.net/2010/04/20/the-antepenultimate-couchdb-reference-card/">The Antepenultimate CouchDB Reference Card (cheat sheet)</a></li>
<li><a href="http://sauceio.com/index.php/2012/05/goodbye-couchdb/">Goodbye, CouchDB</a></li>
<li><a href="http://www.julianbrowne.com/article/viewer/brewers-cap-theorem">Brewer's CAP Theorem</a></li>
<li><a href="http://www.allthingsdistributed.com/2008/12/eventually_consistent.html">Eventually Consistent - Revisited</a> I need to read this.</li>
</ul>

<h2>Instructions</h2>

<p>
Install CouchDB and start it. When Couch starts, 
it will open a tab inside your browser
and retrieve the main page 
of the browser-based interface 
to the database, called <em>Futon</em>.
The instructions in this assignment 
do not involve this interface,
but it is probably useful to learn.
</p>

<p>
I can think of 4 ways to interact with a Couch database.
</p>

<ul>
<li>The browser interface (Futon)</li>
<li>Indirectly through a CouchDB driver written for a specific language</li>
<li>Directly from a language that supports construction of HTTP messages</li>
<li>Command line tools that support the construction of HTTP messages, such as curl</li>
</ul>

<h3>Database Interaction through Curl</h3>

<p>
This assignment uses <a href="http://curl.haxx.se/">curl</a> 
at the command line to explore how Couch works.
</p>

<p>
The following instructions assume that you have not yet set an admin password for your database.
If you set the admin password, then you will need to add the admin name and password with each
of the commands given.
For example, if the admin password were <em>1234</em>, 
then the command to get the names of all the databases on the server would be as follows.
</p>

<pre>
curl -X GET http://root:1234@localhost:5984/_all_dbs
</pre>

<p>
Get an array of names of the databases hosted by the server.
</p>

<pre>
curl -X GET http://localhost:5984/_all_dbs
</pre>

<p>
Create a database named <code>test</code>.
</p>

<pre>
curl -X PUT http://localhost:5984/test
</pre>

<p>
Verify that the database was created by re-running 
the command to list the names of all databases.
</p>

<h3>Database Documents</h3>

<p>
Verify that the test database contains no documents.
</p>

<pre>
curl -X GET http://localhost:5984/test/_all_docs
</pre>

<p>
Consider the following Javascript object.
</p>

<pre>
var obj = { _id: 'a', x: 1 };
</pre>

<p>
Suppose we want to store the current state of this object in the test database.
To do this, we need to describe the object using [JSON](http://json.org/) syntax.
We can either write the JSON string manually, or we can use
the JSON.stringify function to determine it for us.
To do this, run the node command line interpreter.
</p>

<pre>
node
</pre>

<p>
Then, enter the following lines.
</p>

<pre>
obj = { _id: 'a', x: 1};
JSON.stringify(obj);
</pre>

<p>
The node command line interpreter displays the value of the expression entered.
The value of <code>JSON.stringify(obj);</code> is the following string.
</p>

<pre>
'{"_id":"a","x":1}'
</pre>

<p>
The outer apostrophes are used to show that the value is a string;
these are not actually part of the JSON representation of <code>obj</code>.
</p>
 
<p>
Use curl as follows to send the JSON representation of obj to the test database.
Note that the value for the <code>-d</code> argument needs to be quoted.
</p>

<pre>
curl -X POST http://localhost:5984/test -H "Content-type: application/json" -d '{"_id":"a","x":1}'
</pre>

<p>
Use the following command to 
verify that the test database contains contains the document.
</p>

<pre>
curl -X GET http://localhost:5984/test/_all_docs
</pre>

<p>
Insert JSON representations of the following additional Javascript objects.
</p>

<pre>
{ _id: 'b', x: 1 }
{ _id: 'c', x: 2 }
{ _id: 'd', y: 1 }
</pre>

<h3>Views</h3>

<p>
In a Couch database, documents that have ids that are prefixed with _design
have a special function and are called <em>design documents</em>.
Design documents contain Javascript functions that are run at various times.
One type of design document function is called a view.
A view is used to generate derived data from the database,
similar to an SQL query.
</p>

<p>
The following design document has an id of <code>_design/adesign</code>. 
It contains a sub-object
named <code>views</code>, which contains a single view named <code>aview</code>.
This view has map and reduce functions defined.
Couch uses an approach called <code>MapReduce</code> to maintain views efficiently;
you can read about it in
<a href="http://wiki.apache.org/couchdb/Introduction_to_CouchDB_views">Introduction to CouchDB Views</a>.
</p>

<pre>
{
  "_id" : "_design/adesign",
  "views" : {
    "aview" : {
      "map" : "function(doc) { if (doc.x) emit('x', doc.x); }",
      "reduce" : "function(key, values) { return sum(values); }"
    }
  }
}
</pre>

<p>
The view <code>aview</code> computes the sum of all values for <code>x</code> 
that exist in documents within the test database.
</p>

<p>
The design document is inserted into the database 
in the same way any document is inserted.
Because the design document is relatively large, 
it is not convenient to include
it in the command line.
Instead, we store the design document as a file 
and provide the filename in the command line.
</p>

<p>
Create file <em>adesign.json</em> with contents equal to the design document given above.
Then use the following command to insert it into the test database.
</p>

<pre>
curl -X POST http://localhost:5984/test -H "Content-type: application/json" -d @adesign.json
</pre>

<p>
Notice the use of <code>'@'</code> in front of the filename.
This tells curl to treat the string as a filename.
</p>

<p>
Look again at the map function in the design document.
This function is called for each document 
that gets created or modified in the database.
The following is the function reformatted to read more easily.
</p>

<pre>
function(doc) { 
  if (doc.x) {
    emit('x', doc.x); 
  }
}
</pre>

<p>
Each time the function is called,
the function checks to see if <code>doc.x</code> 
evaluates to <code>true</code>.
If it does, then it invokes a function called <code>emit</code>,
which is provided by the Javascript runtime environment of the database.
The function <code>emit</code> 
returns a pair that is used to update a map
that is maintained by the view.
In our case, we associate the name <code>'x'</code> 
with the value of <code>doc.x</code>
when <code>doc.x</code> exists.
</p>

<p>
Now look at the reduce function.
</p>

<pre>
function(key, values) { 
  return sum(values); 
}
</pre>

<p>
The reduce function is called to aggregate values returned by the map function.
The first argument (<code>key</code> above) 
provides information about where the values came from.
See <a href="http://wiki.apache.org/couchdb/Introduction_to_CouchDB_views">Introduction to CouchDB Views</a>
for a detailed explanation.
The second argument of the reduce function (<code>values</code> above)
is an array of values that the reduce function should aggregate into a single value,
which it returns.
In our case, <code>values</code> is an array that contains
values of <code>x</code> that we emitted in the map function.
</p>

<p>
To see the result of the view, do the following.
</p>

<pre>
curl -X GET http://localhost:5984/test/_design/adesign/_view/aview
</pre>

<h3>Database Access Control</h3>

<p>
Currently, there are no database users,
so the Couch server runs every operation submitted to it.
To limit what clients can do, we need to create database users.
</p>

<p>
In Couch, there is a special group of users called <em>admin</em>.
Admin users can perform server administration tasks, 
such as creating and deleting databases.
</p>

<p>
Creating an admin user keeps non-admin users from performing server administration tasks.
Run the following command to 
create an admin user named <em>admin</em> with password <em>1234</em>.
</p>

<pre>
curl -X PUT http://localhost:5984/_config/admins/admin -d '"1234"'
</pre>

<p>
To see that non-authenticated users can no longer create databases,
try to create a database named <code>x</code>.
</p>

<pre>
curl -X PUT http://localhost:5984/x
</pre>

<p>
The above command should now fail because we created an admin user.
To succeed at creating a database,
you need to provide the username 
and password of an admin user in the HTTP request URL.
The following shows how to do this for our example.
</p>

<pre>
curl -X PUT http://admin:1234@localhost:5984/x
</pre>

<p>
Creating an admin user keeps others from performing server administration operations.
However, non-authenticated users can still read and write to our test database because
we have not created a security object for it.
Run the following to see that no users are part of the test database's security object.
</p>

<pre>
curl -X GET http://localhost:5984/test/_security
</pre>

<p>
The security object and security mechanism to support authorization is very flexible.
But we will not investigate this in depth.
Instead, we will use a simple security configuration that makes the admin user the
only user who can write to and read from the database.
</p>

<p>
Create file <em>security.json</em> with the following contents.
</p>

<pre>
{
   "admins" : {
      "roles" : [],
      "names" : ["admin"]
   },
   "readers" : {
      "roles" : [],
      "names" : ["admin"]
   }
}
</pre>

<p>
Run the following command to
write this version of the security object into the test database.
</p>

<pre>
curl -X PUT http://admin:1234@localhost:5984/test/_security -d @security.json -H "Content-type: application/json"
</pre>

<p>
Run the command again to retrieve the security object;
observe that you no longer have read access to it.
</p>

<pre>
curl -X GET http://localhost:5984/test/_security
</pre>

<p>
Verify that you can also not read 
any of the documents we inserted into the test database.
</p>

<pre>
curl -X GET http://localhost:5984/test/a
</pre>

<p>
Now verify that you can perform these reads as the admin user.
</p>

<pre>
curl -X GET http://admin:1234@localhost:5984/test/_security
curl -X GET http://admin:1234@localhost:5984/test/a
</pre>

<h3>Database Creation Script</h3>

<p>
When developing an application that relies on a database,
it is very useful to have a script that resets the application's database
to a specific state.
This allows you to test for specific functionality that you may be in the
process of developing.
It also allows you to easily delete old data that may not be consistent with
recent changes to application logic.
Create a script file named <code>createdb.bat</code> (if on Windows) or
<em>createdb.sh</em> (if on OS X or Linux) that deletes the test database
and then recreates it with the security object and example documents
used in this assignment.
To write this script,
you need to research the CouchDB documentation 
to learn how to delete a database.
(The purpose of not providing the answer to you here is that you should
practice accessing the CouchDB documentation to solve problems.)
</p>

<h3>View Logging</h3>

<p>
It is possible to write to a log file from within design functions.
To illustrate this, add a <code>bview</code> to the design document 
that uses the following map function.
</p>

<pre>
function(doc) {
  log('The doc id is " + doc._id);
}
</pre>

<p>
Run the createdb script to recreate your test database.
Then invoke the bview as follows.
(Add admin credentials as needed in subsequent commands.)
</p>

<pre>
curl -X GET http://localhost:5984/test/_design/adesign/_view/bview
</pre>

<p>
View the contents of the Couch log file to see the result.
Under OS X, the Couch log file is located at <em>~/Library/Logs/couchdb.log</em>.
You can view the log as it's being written with the following command.
</p>

<pre>
tail -f ~/Library/Logs/couchdb.log
</pre>

<p>
Under Linux, the tail command given above is also available,
but the location of the log file will be different.
Use your research skills to determine where this log file is located under Linux.
</p>

<p>
Under Windows, I don't believe the tail command is available by default.
In this case, just open the file in something like notepad to view its
contents, and re-open the file to see new contents that are added to it.
</p>

<p>
While trying to understand how map reduce works, I found it helpful to
call the log function inside the map and reduce functions.
</p>
