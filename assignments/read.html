---
layout: assignment
title: Read Assignment
---

<div class="csusbdt-video-btn">
  <a class="btn btn-success" role="button" target="_blank" href="">Video</a>
</div>

<h2>Overview</h2>

<p>
The purpose of this assignment is 
to learn how to read documents from a CouchDB database 
from inside a Node.js program.  
This will also give you experience accessing 
remote services using HTTP.
Such services are sometimes referred to as <em>Web services</em>
and are very common in software systems these days.
</p>

<p>
This assignment builds on the ajax and couch assignments.
In the ajax assignment, 
we created a Web page that uses ajax 
to request a message string from the server, 
which it displays to the user. 
However, the message string 
was hard-coded into the program. 
In this assignment, we will 
use what we learned in the couch assignment
to retrieve the message string 
from a CouchDB database.
</p>

<h2>Assignment Folder</h2>

<p>
Create a directory named <em>read</em> 
for the work you do for this assignment. 
At the end of the assignment, 
this folder will contain the following files.
</p>

<ul>
<li>createdb.bat (if on Windows) or createdb.sh (if on OS X or Linux)</li>
<li>test_update.bat (if on Windows) or test_update.sh (if on OS X or Linux)</li>
<li>security.json</li>
<li>message.js</li>
<li>root.js</li>
<li>image.js</li>
<li>main.js</li>
<li>response.js</li>
<li>db.js</li>
</ul>

<h2>Reading</h2>

<ul>
<li>Read the Node.js documentation related to making HTTP requests,
    starting from  
    <a href="http://nodejs.org/api/http.html#http_http_request_options_callback">http.request</a>.
</li>
</ul>

<h2>Instructions</h2>

<h3>Copy Existing Code</h3>

<p>
Copy your app server code from the cache assignment 
to the <em>read</em> folder as a starting point.
</p>

<p>
Test that the application is working correctly by visiting 
<a href="http://localhost:5000/">http://localhost:5000/</a> 
in a browser.
</p>

<h3>Create Database</h3>

<p>
Start your CouchDB server if not already started.
</p>

<p>
Use what you learned from the CouchDB assignment 
to modify the file <em>createdb.sh</em> 
to create a database called <em>read</em>
and insert a single document into this database
with a property named <em>msg</em>.
This property should be set to the string "the read assignment".
Also, specify the value <em>message</em> for the <code>_id</code> 
field so that we can identify
this document in a straightforward way.
</p>

<p>
Modify <em>test_update.sh</em> so that it changes
the message in the database.
</p>

<h3>Create Database Interaction Module</h3>

<p>
Create file named <code>db.js</code>
with the following code.
This module exposes a <code>getMsg</code> function
that retrieves the message from the database.
</p>

<div class="csusbdt-code-title">db.js</div>

<pre>
var assert      = require('assert');
var querystring = require('querystring');
var http        = require('http');

exports.getMsg = function(cb) {
  var options = {
      hostname: 'localhost',
      auth: 'admin:1234',
      port: 5984,
      path: '/read/message', 
      method: 'GET'
  };
  send(options, function(err, data) {   
    if (err) {                 
      console.log(err.message);         
      return cb(err);                         
    }
    if (data.msg === undefined) {
      throw new Error(
        'msg property missing from msg document.\n' + JSON.stringify(data)
      );
    }
    cb(null, data.msg);
  });
};

// Send request and receive data (a Javascript object).
// options are the same as for http.request
// cb = function(data) where data is Error or Object
function send(options, cb) {
  var req;
  
  // create request
  req = http.request(options, function(res) {
    var dataString;  // to be converted to Javascript object
    
    // tell node how to convert received bytes to a Javascript string
    res.setEncoding('utf8');
    
    // accumulate data
    res.on('data', function (chunk) {
      if (dataString === undefined) dataString = chunk; else dataString += chunk;
    });
    
    // parse received data
    res.on('end', function() {
      var data;
      try {
        data = JSON.parse(dataString);
      } catch (err) {
        return cb(err);
      }
      cb(null, data);            
    });
  });
  
  // register error listener
  req.on('error', function(err) { 
    err.message += '\ndb.send: request error';
    cb(err); 
  });
  
  // send request
  req.end();
};
</pre>

<p>
The <code>db.getMsg</code> calls the <code>read</code> function,
which calls the Node.js <code>request</code> function 
from the <code>http</code> module.
The <code>request</code> function returns an instance of <code>ClientRequest</code>.
This is used to send an HTTP message to the database server.
So, in this part of our code,
our Web server plays the role of a Web client.
</p>

<h3>Modify the Message Request Handler</h3>

<p>
Now that we have a way to retrieve the message string
from the database,
we can modify the message request handler to 
get the message string this way.
You should modify the message request handler 
to retrieve the message string from the database
using our new <code>db</code> module.
</p>

<h3>Test</h3>

<p>
First, test that the browser gets the current message from our server
and the server code runs without error.
</p>

<p>
Second, while our server is running,
run <em>test_update.sh</em> to set a 
different message.
Then click on the <em>make a request</em> link
to see that the new message
is displayed to the user.
Do this test without restarting the Web application server.
</p>

