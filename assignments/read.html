---
layout: assignment
title: Read Assignment
---

<h2>Overview</h2>

<p>
The purpose of this assignment is 
to learn how to read documents from a CouchDB database 
from inside a Node.js program.  
This assignment will also give you experience accessing 
remote services using HTTP.
Such services are sometimes referred to as <em>Web services</em>.
</p>

<p>
This assignment builds on the ajax and couch assignments.
In the ajax assignment, 
we created a Web page that uses ajax 
to request a message string from the server, 
which it displays to the user. 
In the ajax assignment, the message string 
was hard-coded into the program. 
In this assignment, we will retrieve the message string from the database.  
</p>

<h2>Assignment folder</h2>

<p>
Create a directory named <em>couch</em> 
for the work you do for this assignment. 
At the end of the assignment, 
this folder will contain the following files.
</p>

<ul>
<li>README.md</li>
<li>createdb.bat (if on Windows) or createdb.sh (if on OS X or Linux)</li>
<li>security.json</li>
<li>design.json</li>
<li>message.js</li>
<li>root.js</li>
<li>db.js</li>
<li>main.js</li>
<li>response.js</li>
</ul>

<h2>Reading</h2>

<ul>
<li>Read relevant parts of the CouchDB documentation.</li>
<li>Read the Node.js documentation on HTTP client.</li>
</ul>

<h2>Instructions</h2>

<h3>Copy Existing Code</h3>

<p>
Copy your app server code from the cache assignment 
to the <em>read</em> folder as a starting point.
Test that the application is working correctly by visiting 
<a href="http://localhost:5000/">http://localhost:5000/</a> 
in a browser.
</p>

<h3>Create Database</h3>

<p>
Start your CouchDB server.
</p>

<p>
Use what you learned from the CouchDB assignment 
to create file <em>createdb.sh</em> 
that contains commands to create a database called <em>read</em>.
The create script should insert a document with a property named <em>msg</em>.
This property should be set to the string <em>the read assignment</em>.
Also, specify the value <em>message</em> for the <code>_id</code> 
field so that we can identify
this document in a straightforward way.
</p>

<h3>Create Database Interaction Module</h3>

<p>
Create file named <code>db.js</code>
with the following code.
This module exposes a <code>getMsg</code> function
that retrieves the message from the database.
</p>

<div class="csusbdt-code-title">db.js</div>

<pre>
var assert      = require('assert');
var querystring = require('querystring');
var http        = require('http');

exports.getMsg = function(cb) {
  var options = {
      hostname: 'localhost',
      auth: 'admin:1234',
      port: 5984,
      path: '/read/msg', 
      method: 'GET'
  };
  send(options, function(err, data) {   
    if (err) {                 
      console.log(err.message);         
      cb(err);                         
    }
    if (data.msg === undefined) {
      throw new Error(
        'msg property missing from msg document.\n' + JSON.stringify(data)
      );
    }
    cb(null, data.msg);
  });
};

// Send request and receive data (a Javascript object).
// options are the same as for http.request
// cb = function(data) where data is Error or Object
function send(options, cb) {
  var req;
  
  // create request
  req = http.request(options, function(res) {
    var dataString;  // to be converted to Javascript object
    
    // tell node how to convert received bytes to a Javascript string
    res.setEncoding('utf8');
    
    // accumulate data
    res.on('data', function (chunk) {
      if (dataString === undefined) dataString = chunk; else dataString += chunk;
    });
    
    // parse received data
    res.on('end', function() {
      var data;
      try {
        data = JSON.parse(dataString);
      } catch (err) {
        return cb(err);
      }
      cb(null, data);            
    });
  });
  
  // register error listener
  req.on('error', function(err) { 
    err.message += '\ndb.send: request error';
    cb(err); 
  });
  
  // send request
  req.end();
};
</pre>

<p>
The <code>db.getMsg</code> calls the <code>read</code> function,
which calls the Node.js <code>request</code> function 
from the <code>http</code> module.
The <code>request</code> function returns an instance of <code>ClientRequest</code>.
This is used to send an HTTP message to the database server.
So, in this part of our code,
our Web server plays the role of a Web client.
</p>

<h3>Modify the Message Request Handler</h3>

<p>
Now that we have a way to retrieve the message string
from the database,
we can modify the message request handler to 
get the message string this way.
You should modify the message request handler 
to retrieve the message string from the database
using our new <code>db</code> module.
</p>

<h3>Test</h3>

<p>
First, test that the browser gets the current mesage from our server
and the server code runs without error.
</p>

<p>
Second, while our server is running,
modify the datbase creation script to insert a 
different message.
Then refresh the Web page and observe that the new
message is displayed to the user.
Do this test without restarting the Web application server.
</p>

