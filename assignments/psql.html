---
layout: assignment
title: PostreSQL Assignment
---

<div class="csusbdt-video-btn">
  <a class="btn btn-default" role="button" href="#">No Video</a>
</div>

<h2>Overview</h2>

<p>
The purpose of this assignment 
is to learn about relational databases
and how to use a relational database 
called <a href="http://www.postgresql.org/">PostqreSQL</a>.
</p>

<p class="csusbdt-callout">
<a href="http://www.postgresql.org/files/postgresql.mp3">How to pronounce PostgreSQL?</a>
</p>

<p>
This assignment builds on the gift assignment.
</p>

<p>
This assignment requires more research and self-study than previous assignments.
</p>

<p>
Install PostgreSQL and start it. 
</p>

<p>
Under OS X, download the Postgres.app and copy it into your Applications folder.
Add the following export to <em>~/.bash_profile</em>;
this will let you easily launch the command line tools inside a terminal window.
</p>

<pre>
export PATH="/Applications/Postgres93.app/Contents/MacOS/bin:$PATH"
</pre>

<p>
Double click the Postgres.app to start it.
It will run in the background from that point.
</p>

<p>
I believe the standard installer for Windows is straight forward to use.
Let me know if this is not the case.
</p>

<p>
You might need to study the following to
start postresql in the labs:
http://www.postgresql.org/docs/8.1/static/postmaster-start.html
</p>

<p>
Find and do a tutorial to learn the basics
of SQL using the PostgreSQL database.
The tutorial in 
<a href="http://www.postgresql.org/docs/9.3/static/index.html">the
PostgreSQL documentation</a>
may be sufficient.
</p>

<h2>Assignment folder</h2>

<p>
The starting point for this assignment 
is the code you developed for the gift assignment.
Make a copy of your <em>gift</em> 
folder and name it <em>psql</em>.
</p>

<p>
We will completely replace the contents of the scripts folder.
For this reason, start by deleting the files in <em>~/405/psql/scripts</em>.
</p>

<p>
Inside the <em>psql</em> folder,
create file <em>gift.sql</em> with the following contents.
</p>

<pre>
DROP TABLE users;

CREATE TABLE users (
    _id       varchar(80) primary key,
    _rev      varchar(80),
    pw        varchar(80),
    balance   real,
    gems      int,
    score     int
);

INSERT INTO users VALUES ('a', '0', 'a', 5, 0, 0);
INSERT INTO users VALUES ('b', '0', 'b', 0, 0, 0);
</pre>

<p>
Create <em>local.sh</em> with the following contents.
</p>

<pre>
psql -d gift -f gift.sql
</pre>

<p>
Run <em>local.sh</em> to create the gift database with the local PostgreSQL server.
</p>

<p>
Replace <em>db.js</em> with the following.
</p>

<pre>
var assert      = require('assert');
var querystring = require('querystring');
var http        = require('http');
var pg          = require('pg');

var url = 'postgres://localhost/gift';

exports.init = function(cb) {
  pg.connect(url, function(err, client, done) {
    if (err) throw err;
    client.query("select * from users where _id = 'a'", function (err, result) {
      done();
      if (err) throw err;
      cb();
    })
  });
};

exports.getDoc = function(_id, cb) {
  pg.connect(url, function(err, client, done) {
    if (err) return cb(err);
    client.query('select * from users where _id = $1', [_id], function (err, result) {
      done();
      if (err) return cb(err);
      if (result.rows.length === 0) {
        return cb(null, null);
      }
      cb(null, result.rows[0]);
    });
  });
};

exports.updateDoc = function(doc, cb) {
  pg.connect(url, function(err, client, done) {
    if (err) return cb(err);
    var nextRev = (parseInt(doc._rev) + 1).toString();
    client.query("update users set balance = $1, gems = $2, _rev = $3 where _id = $4 and _rev = $5",
                 [doc.balance, doc.gems, nextRev, doc._id, doc._rev],
                 function (err, result) {
      done();
      if (err) {
        cb(err);
      } else if (result.rowCount === 0) {
        // Assume the doc is there. If it's not, I think the code still works fine.
        cb(null, { old: true });
      } else {
        cb(null, { rev: nextRev });
      }
    });
  });
};
</pre>

<p>
Install a PostgreSQL driver.
</p>

<pre>
cd ~/405/psql
npm install pg
</pre>

<p>
Test that the app works.
</p>

<h2>Reading</h2>

<p>
To become familiar with the SQL language, read 
<a href="http://www.postgresql.org/docs/9.3/static/index.html">the
PostgreSQL documentation</a>.
The following are the SQL operations used in this assignment.
</p>

<ul>
<li>create a database</li>
<li>delete a database</li>
<li>create a table</li>
<li>insert a new row in a table</li>
<li>get a row of data using a primary key</li>
<li>update a row in a table based on a primary key</li>
</ul>

