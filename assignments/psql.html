---
layout: assignment
title: PostreSQL Assignment
---

<div class="csusbdt-video-btn">
  <a class="btn btn-success" role="button" target="_blank" href="http://youtu.be/7a-xXaG1-jo">Video</a>
</div>

<h2>Overview</h2>

<p>
The purpose of this assignment 
is to learn about relational databases
and how to use a relational database 
called <a href="http://www.postgresql.org/">PostqreSQL</a>.
</p>

<p class="csusbdt-callout">
<a href="http://www.postgresql.org/files/postgresql.mp3">How to pronounce PostgreSQL?</a>
</p>

<p>
This assignment builds on the gift assignment.
We will replace the CouchDB database in the gift assignment
with a PostgreSQL database.
</p>
<h2>Setup</h2>

<p>
This assignment requires that you have access to a PostgreSQL database.
Install PostgreSQL and start it.
How you do this depends on your operating system and maybe other factors.
</p>

<p>
Under OS X ...
</p>

<blockquote>

<p>
Download the Postgres.app and copy it into your Applications folder.
Add the following export to <em>~/.bash_profile</em>;
this will let you easily launch the command line tools inside a terminal window.
</p>

<pre>
export PATH="/Applications/Postgres93.app/Contents/MacOS/bin:$PATH"
</pre>

<p>
Double click the Postgres.app to start it.
It will run in the background from that point.
</p>

</blockquote>

<p>
Under Windows ...
</p>

<blockquote>

<p>
Use the standard installer for Windows.
During installation and setup, select defaults when available.
Leave the username as <em>postgres</em> but you will need to pick a password.
The password is not critical, unless you plan to open up your database to the outside,
so set something easy to remember.
Do not run StackBuilder; exit when you reach this point.
</p>

<p>
To run the PostgreSQL server, run the following from the command line.
Adjust the path to match the location of <em>runpsql.bat</em> in your system.
</p>

<pre>
"C:\Program Files\PostgreSQL\9.3\scripts\runpsql.bat"
</pre>

<p>
Run the following script in terminal window to set up the environmental variables
to run PostgreSQL commands at the command line.
</p>

<pre>
"C:\Program Files\PostgreSQL\9.3\pg_env.bat"
</pre>

</blockquote>

<p>
In JB 359 ...
</p>

<blockquote>

<p>
You might need to study the following to
start postresql in the labs:
http://www.postgresql.org/docs/8.1/static/postmaster-start.html
</p>

</blockquote>

<p>
After starting the server, run the following in a terminal window to 
create a database named <em>gift</em>.
</p>

<pre>
createdb gift
</pre>

<h2>Study</h2>

<p>
To become familiar with the SQL language, read 
<a href="http://www.postgresql.org/docs/9.3/static/index.html">the
PostgreSQL documentation</a>.
The following are the SQL operations used in this assignment.
</p>

<ul>
<li>create a database</li>
<li>delete a database</li>
<li>create a table</li>
<li>insert a new row in a table</li>
<li>get a row of data using a primary key</li>
<li>update a row in a table based on a primary key</li>
</ul>

<p>
Find and do a tutorial to learn the basics
of SQL using the PostgreSQL database.
The tutorial in 
<a href="http://www.postgresql.org/docs/9.3/static/index.html">the
PostgreSQL documentation</a>
may be sufficient.
</p>

<h2>Assignment folder</h2>

<p>
The starting point for this assignment 
is the code you developed for the gift assignment.
Make a copy of your <em>gift</em> 
folder and name it <em>psql</em>.
</p>

<p>
We will completely replace the contents of the scripts folder.
For this reason, start by deleting the files in <em>~/405/psql/scripts</em>.
</p>

<h2>Database Creation Script</h2>

<p>
Inside the <em>psql/scripts</em> folder,
create file <em>gift.sql</em> with the following contents.
This script creates a table named <em>users</em> and inserts two rows into the table.
</p>

<pre>
DROP TABLE users;

CREATE TABLE users (
    _id       varchar(80) primary key,
    _rev      varchar(80),
    pw        varchar(80),
    balance   real,
    gems      int,
    score     int
);

INSERT INTO users VALUES ('a', '0', 'a', 5, 0, 0);
INSERT INTO users VALUES ('b', '0', 'b', 0, 0, 0);
</pre>

<p>
Create <em>local.sh</em> with the following contents.
(Name the file <em>local.bat</em> if you are on Windows.)
</p>

<pre>
psql -h localhost -d gift -f gift.sql
</pre>

<p>
Run <em>local.sh</em> to create the gift database with the local PostgreSQL server.
</p>

<h2>Install Database Driver</h2>

<p>
With CouchDB we could easily interact directly with the database
because the interaction is based on HTTP protocol and JSON.
This is not the case with PostgreSQL.
Rather than implementing the communication protocol needed,
we will use a Node.js library called <em>pg</em> to
simplify the process of issuing commands to the database and
receiving their reults.
</p>

<p>
Install a PostgreSQL driver.
</p>

<pre>
cd ~/405
npm install pg
</pre>

<p>
The above command creates a folder named <em>node_modules</em>
in the root level of the repository.
When we run Node.js in the psql subfolder,
Node.js searches upward through the parent folders of the current directory
for the presence of node_module folders.
It will search these folders for modules that are loaded through the <code>require</code> function.
For this reason, we can place library dependencies in <em>~/405</em>.
Also, we do this in prepartion for the next assignment,
where we need to have the <em>pg</em> located at this level.
</p>

<h2>Replace the Database Module</h2>

<p>
In the gift application server code we separated database interaction from
the resource request handlers by placing all database code in a module
named <code>db</code>.
This organization is an example of the principle of
<em>separation of concerns</em>.
This gives us a big benefit at this point;
we only need to modify a single module
in order to replace the underlying database.
All other code can remain unchanged.
</p>

<p>
Replace <em>db.js</em> with the following.
</p>

<blockquote>

<p>
On Windows, replace <code>'postgres://postgres@localhost/gift'</code>
with <code>'postgres://localhost/gift'</code> in the following.
</p>

</blockquote>

<pre>
var pg = require('pg');

var url = 'postgres://localhost/gift';

exports.init = function(cb) {
  pg.connect(url, function(err, client, done) {
    if (err) throw err;
    client.query("select * from users where _id = 'a'", function (err, result) {
      done();
      if (err) throw err;
      cb();
    })
  });
};

exports.getDoc = function(_id, cb) {
  pg.connect(url, function(err, client, done) {
    if (err) return cb(err);
    client.query('select * from users where _id = $1', [_id], function (err, result) {
      done();
      if (err) return cb(err);
      if (result.rows.length === 0) {
        return cb(null, null);
      }
      cb(null, result.rows[0]);
    });
  });
};

exports.updateDoc = function(doc, cb) {
  pg.connect(url, function(err, client, done) {
    if (err) return cb(err);
    var nextRev = (parseInt(doc._rev) + 1).toString();
    client.query("update users set balance = $1, gems = $2, score = $3, _rev = $4 where _id = $5 and _rev = $6",
                 [doc.balance, doc.gems, doc.score, nextRev, doc._id, doc._rev],
                 function (err, result) {
      done();
      if (err) {
        cb(err);
      } else if (result.rowCount === 0) {
        // Assume the doc is there. If it's not, I think the code still works fine.
        cb(null, { old: true });
      } else {
        cb(null, { rev: nextRev });
      }
    });
  });
};
</pre>

<h2>Test</h2>

<p>
Use a browser to test that the app works.
</p>

